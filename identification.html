<!DOCTYPE html>
<html>
    <head>
        <title>Identify The Animals</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.476.0.min.js"></script>
        <script>
            AWS.config.region = 'us-east-1'; // Region
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-east-1:03dd8b12-9e10-484c-83ca-bfe0d55e16c3',
            });
            var lambda = new AWS.Lambda({region: 'us-east-1', apiVersion: '2015-03-31'});

            var urlParams = new URLSearchParams(location.search);
            var name = "";
            var image = "";
            if (urlParams.has('image') && urlParams.has('name')) {
                image = urlParams.get('image');
                name = urlParams.get('name');
            }
            else {
                window.location = "login.html";
            }

            function load(){
                document.getElementById('name').innerHTML = "Logged in as: <b>"+name+"</b>";

                document.getElementById('img').innerHTML = "<img src=\"img\\"+image+"\" class = \"animal\">";
            }

            function vote() {
                voteOptions = [
                    "deer",
                    "fox",
                    "nothing",
                    "unsure"
                ];
                const endDate = new Date();
                const spentTime = endDate.getTime() - startDate.getTime();
                elapsedTime += spentTime;
                elapsedTime /= 1000;
                var votes = []; 
                for (i = 0; i<voteOptions.length; i++){
                    if (document.getElementById(voteOptions[i]).checked) {
                        votes.push(voteOptions[i]);
                    }
                }
                var params = {
                    'FunctionName' : 'id',
                    'name' : name,
                    'votes' : votes,
                    'time' : elapsedTime,
                    'pic' : image
                };
                /*
                passes photo, vote, name, and time to the lambda function
                returns the next pic which will then be passed to the next page using url parameters

                lambda function:
                    will change photo (probably by just getting the next photo) then store that photo's id
                    add elapsed time to current elapsed time in database
                    store vote with picture
                */
                lambda.invoke(params, function(err, data) {
                    if (err) {
                        window.alert("An error has occured please try again");
                        console.log(error);
                    }
                    else {
                        window.location = "identification.html?name="+name+"&image="+data['image'];
                    }
                }); 
            }

            // track time on page
            var startDate = new Date();
            var elapsedTime = 0;

            const focus = function() {
                startDate = new Date();
            };

            const blur = function() {
                const endDate = new Date();
                const spentTime = endDate.getTime() - startDate.getTime();
                elapsedTime += spentTime;
            };

            window.addEventListener('focus', focus);
            window.addEventListener('blur', blur);
        </script>
    </head>
    <body onload="load()">
        <h1>What animal is in the picture below?</h1>
        <div id = 'img'></div>
        <br>
        <div id = 'form'>
            <form class = 'form'>
                <table>
                    <tr>
                        <td>
                            <input type = 'checkbox' class = 'check' id = 'deer' value = 'Deer'>
                            <label for='deer'>Deer</label>
                        </td>
                        <td>
                            <input type = 'checkbox' class = 'check' id = 'fox' value = 'Fox'>
                            <label for='fox'>Fox</label>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input type = 'checkbox' class = 'check' id = 'nothing' value = 'Nothing'>
                            <label for='nothing'>Nothing</label>
                        </td>
                        <td>
                            <input type = 'checkbox' class = 'check' id='unsure' value = 'Unsure'>
                            <label for='unsure'>Unsure</label>
                        </td>
                    </tr>
                </table>
                <br>
                <button onclick='vote()'>Submit</button>
            </form>
        </div>
        <br><br><br>
        <div id='header'>
            <a href='thanks.html'><button>I'm Done</button></a>
            <p id='name'></p>
        </div>
    </body>
</html>